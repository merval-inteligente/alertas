# üö® API de Alertas - Noticias y Tweets

Sistema FastAPI que analiza noticias y tweets desde MongoDB, generando alertas autom√°ticas inteligentes basadas en **scoring de relevancia**, palabras clave contextuales, y detecci√≥n de patrones financieros.

---

## üìã Tabla de Contenidos

- [Caracter√≠sticas](#-caracter√≠sticas)
- [Instalaci√≥n](#-instalaci√≥n)
- [Configuraci√≥n](#-configuraci√≥n)
- [Ejecuci√≥n](#-ejecuci√≥n)
- [Endpoints](#-endpoints)
- [Modelos de Datos](#-modelos-de-datos)
- [Tipos de Alertas](#-tipos-de-alertas)
- [Sistema de Scoring](#-sistema-de-scoring)
- [Ejemplos de Uso](#-ejemplos-de-uso)
- [Personalizaci√≥n](#-personalizaci√≥n)

---

## ‚ú® Caracter√≠sticas

- üîå Conexi√≥n a MongoDB Atlas (Motor async)
- üì∞ An√°lisis de noticias (colecci√≥n `news`)
- üê¶ An√°lisis de tweets (colecci√≥n `tweets`)
- üéØ **Sistema de scoring inteligente** para relevancia
- üìä Detecci√≥n prioritaria de tickers argentinos (`YPF`, `GGAL`, `PAMP`, etc.)
- üß† An√°lisis contextual (palabras de magnitud, porcentajes, montos)
- ‚è∞ Filtros temporales (√∫ltimas 24h noticias, 12h tweets)
- üïê Ajuste de sensibilidad seg√∫n horario de mercado
- üî• Identificaci√≥n de contenido viral con engagement
- üíæ Almacenamiento en MongoDB (colecci√≥n `alerts`)
- üéØ Sistema de prioridades (low, medium, high, critical)
- üåê API REST completa con FastAPI

> **Nota:** Este sistema usa **an√°lisis basado en reglas mejorado** con scoring contextual y umbrales din√°micos, no Machine Learning.

---

## ÔøΩ Instalaci√≥n

```bash
# Clonar/Descargar el proyecto
cd Alertas

# Instalar dependencias
pip install fastapi uvicorn[standard] motor pymongo python-dotenv pydantic pydantic-settings
```

---

## ‚öôÔ∏è Configuraci√≥n

Crear archivo `.env` en la ra√≠z del proyecto:

```env
MONGODB_URI=mongodb+srv://admin:password@cluster.mongodb.net/MervalDB?retryWrites=true&w=majority
DATABASE_NAME=MervalDB
DB_PORT=27017
```

---

## ‚ñ∂Ô∏è Ejecuci√≥n

```bash
# Opci√≥n 1: Directo
python main.py

# Opci√≥n 2: Con uvicorn
uvicorn main:app --reload

# Opci√≥n 3: Puerto personalizado
uvicorn main:app --host 0.0.0.0 --port 8000
```

**URL:** `http://localhost:8000`

**Documentaci√≥n:** `http://localhost:8000/docs`

---

## ÔøΩ Endpoints

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| `GET` | `/` | Info de la API |
| `GET` | `/health` | Estado de conexi√≥n |
| `GET` | `/news` | Todas las noticias |
| `GET` | `/news/recent?limit=50` | Noticias recientes |
| `GET` | `/tweets` | Todos los tweets |
| `GET` | `/tweets/recent?limit=100` | Tweets recientes |
| `GET` | `/alerts` | Todas las alertas |
| `POST` | `/alerts/generate` | ‚≠ê Generar alertas (combinado) |
| `POST` | `/alerts/generate/news` | Alertas solo de noticias |
| `POST` | `/alerts/generate/tweets` | Alertas solo de tweets |
| `DELETE` | `/alerts` | Eliminar todas las alertas |

---

## üìä Modelos de Datos

### News (Noticias)

```python
{
  "_id": "ObjectId",           # ID de MongoDB
  "title": "string",           # T√≠tulo de la noticia
  "content": "string",         # Contenido completo
  "source": "string",          # Fuente (ej: "√Åmbito")
  "url": "string",             # URL de la noticia
  "published_date": "datetime", # Fecha de publicaci√≥n
  "category": "string",        # Categor√≠a
  "keywords": ["string"]       # Palabras clave
}
```

### Tweet (Tweets)

```python
{
  "_id": "ObjectId",
  "text": "string",            # Contenido del tweet
  "author": "string",          # Nombre del autor
  "username": "string",        # @username
  "created_at": "datetime",    # Fecha de creaci√≥n
  "retweet_count": "int",      # Cantidad de RTs
  "like_count": "int",         # Cantidad de likes
  "reply_count": "int",        # Cantidad de respuestas
  "hashtags": ["string"],      # Hashtags
  "mentions": ["string"],      # Menciones
  "url": "string"              # URL del tweet
}
```

### Alert (Alertas)

```python
{
  "_id": "ObjectId",
  "title": "string",           # T√≠tulo de la alerta
  "description": "string",     # Descripci√≥n detallada
  "type": "string",            # 'news', 'price', 'volume', 'portfolio'
  "enabled": "boolean",        # Estado (default: true)
  "icon": "string",            # Icono UI (ej: 'warning', 'trending-up')
  "config": {                  # Configuraci√≥n espec√≠fica
    "symbol": "string",        # Ticker (ej: "YPF", "$AAPL")
    "condition": "string",     # Tipo de condici√≥n
    "threshold": "number",     # Umbral num√©rico
    "timeframe": "string",     # Marco temporal ('1h', '1d')
    "engagement": "number",    # Engagement (solo tweets)
    "username": "string",      # Usuario (solo tweets)
    "source": "string",        # Fuente original
    "url": "string"            # URL de la fuente
  },
  "createdAt": "datetime",     # Fecha de creaci√≥n
  "lastTriggered": "datetime", # √öltima activaci√≥n
  "triggerCount": "int",       # Veces activada
  "priority": "string",        # 'low', 'medium', 'high', 'critical'
  "sourceTitle": "string",     # T√≠tulo de la fuente original
  "sourceId": "string",        # ID de la noticia/tweet original
  "keywords": ["string"],      # Palabras clave detectadas
  "metadata": {                # Metadata adicional
    "content_type": "string",  # 'news' o 'tweet'
    "author": "string",        # Autor (tweets)
    "engagement": "number",    # Engagement total (tweets)
    "retweets": "number",      # RTs (tweets)
    "likes": "number",         # Likes (tweets)
    "tickers": ["string"],     # Tickers detectados (tweets)
    "hashtags": ["string"],    # Hashtags (tweets)
    "category": "string",      # Categor√≠a (news)
    "source": "string"         # Fuente
  }
}
```

---

## üéØ Tipos de Alertas

### Por Tipo (`type`)

| Tipo | Descripci√≥n | Ejemplo |
|------|-------------|---------|
| `news` | Noticias y eventos | Noticias cr√≠ticas, positivas |
| `price` | Movimientos de precio | Ca√≠das importantes |
| `volume` | Volumen anormal | Tweets virales, tendencias |
| `portfolio` | Alertas de cartera | (Futuro) |

### Por Prioridad (`priority`)

| Prioridad | Condici√≥n | Ejemplo |
|-----------|-----------|---------|
| `critical` | Eventos cr√≠ticos + viralidad | Crisis en tweet viral |
| `high` | Movimientos importantes | Ca√≠das, alertas sociales |
| `medium` | An√°lisis, tendencias | Volatilidad, tickers virales |
| `low` | Informativo, positivo | Noticias generales, ganancias |

---

## üß† Sistema de Scoring

El sistema eval√∫a la relevancia de cada noticia/tweet mediante un **score de 0.0 a 2.0+**:

### Componentes del Score

1. **Peso Base de Keyword** (0.5 - 1.0)
   - `critical`: 1.0 (crisis, default, colapso)
   - `high`: 0.8 (ca√≠da, alza, volatilidad)
   - `medium`: 0.6 (an√°lisis, proyecci√≥n)
   - `positive`: 0.5 (ganancia, r√©cord)

2. **Contexto** (+0.2 - +0.5)
   - Palabras de refuerzo cerca de la keyword
   - Ejemplo: "ca√≠da **fuerte**" ‚Üí +0.3

3. **Magnitud** (√ó1.2 - √ó1.5)
   - Palabras como "fuerte", "hist√≥rico", "r√©cord"
   - Multiplican el score base

4. **Porcentajes Detectados** (+0.1 - +0.3)
   - Presencia de % espec√≠ficos aumenta relevancia

5. **Engagement (Tweets)** (√ó1.2 - √ó1.5)
   - >100 engagement: √ó1.2
   - >500 engagement: √ó1.5

### Umbrales de Creaci√≥n

Las alertas se crean cuando **score ‚â• threshold**:

| Prioridad | Threshold Normal | Durante Mercado |
|-----------|-----------------|-----------------|
| `critical` | 0.8 | 0.64 (-20%) |
| `high` | 0.6 | 0.48 (-20%) |
| `medium` | 0.5 | 0.40 (-20%) |
| `positive` | 0.7 | 0.56 (-20%) |

> **Horario de mercado argentino:** Lunes a Viernes, 11:00-17:00 ART

### Ejemplo de C√°lculo

**Noticia:** "YPF sufre ca√≠da fuerte del 8% por default de Argentina"

```python
# 1. Keyword "ca√≠da" (high) ‚Üí peso base: 0.8
# 2. Contexto "fuerte" ‚Üí +0.3
# 3. Magnitud "fuerte" ‚Üí √ó1.3
# 4. Porcentaje "8%" ‚Üí +0.2
# 5. Score final: (0.8 + 0.3) √ó 1.3 + 0.2 = 1.63

# ‚úÖ 1.63 > 0.6 (threshold high) ‚Üí Se crea alerta HIGH
```

### Filtros Temporales

- **Noticias:** √öltimas 24 horas
- **Tweets:** √öltimas 12 horas

### Tickers Priorizados

El sistema prioriza **20 tickers argentinos**:
```
YPF, GGAL, PAMP, ALUA, BMA, COME, CRES, EDN, 
LOMA, MIRG, SUPV, TECO2, TGNO4, TGSU2, TRAN, 
TXAR, VALO, CEPU, BYMA, BBAR
```

---

### Iconos Utilizados

| Icono | Uso |
|-------|-----|
| `trending-up` | Noticias positivas, subas |
| `trending-down` | Ca√≠das, p√©rdidas |
| `warning` | Alertas cr√≠ticas |
| `stats-chart` | An√°lisis de mercado |
| `flash` | Tendencias virales |
| `bar-chart` | Volumen anormal |
| `document-text` | Noticias generales |

---

## ÔøΩ Ejemplos de Uso

### 1. Generar Alertas (Noticias + Tweets)

```bash
curl -X POST http://localhost:8000/alerts/generate
```

**Respuesta:**
```json
{
  "success": true,
  "alerts_created": 145,
  "news_processed": 100,
  "tweets_processed": 200,
  "message": "Se procesaron 100 noticias y 200 tweets. Se crearon 145 alertas",
  "alerts": [...]
}
```

### 2. Ver Alertas Generadas

```bash
curl http://localhost:8000/alerts
```

### 3. Obtener Tweets Recientes

```bash
curl http://localhost:8000/tweets/recent?limit=50
```

### 4. Python - Filtrar por Prioridad

```python
import requests

# Obtener todas las alertas
response = requests.get('http://localhost:8000/alerts')
alerts = response.json()

# Filtrar por prioridad
critical = [a for a in alerts if a['priority'] == 'critical']
high = [a for a in alerts if a['priority'] == 'high']

print(f"Alertas cr√≠ticas: {len(critical)}")
print(f"Alertas altas: {len(high)}")
```

### 5. Python - Alertas por Ticker

```python
import requests

response = requests.get('http://localhost:8000/alerts')
alerts = response.json()

# Buscar alertas de un ticker espec√≠fico
ypf_alerts = [
    a for a in alerts 
    if 'YPF' in a.get('config', {}).get('symbol', '') or
       'YPF' in str(a.get('keywords', []))
]

for alert in ypf_alerts:
    print(f"[{alert['priority'].upper()}] {alert['title']}")
```

---

## üõ†Ô∏è Personalizaci√≥n

### Modificar Palabras Clave

Edita `services.py` en las funciones `analyze_news_for_alerts()` y `analyze_tweet_for_alerts()`:

```python
# Ejemplo: agregar nueva palabra cr√≠tica
critical_keywords = ['crisis', 'crash', 'colapso', 'quiebra', 'default', 'suspensi√≥n', 'bancarrota']
```

### Ajustar Umbral de Viralidad

En `services.py`, m√©todo `analyze_tweet_for_alerts()`:

```python
# Cambiar de 100 a 500
is_viral = engagement > 500
```

### Cambiar L√≠mites de Procesamiento

En `services.py`, m√©todos `process_*_and_create_alerts()`:

```python
# Cambiar cantidad de items a procesar
news_list = await NewsService.get_recent_news(limit=200)  # era 100
tweets_list = await TweetService.get_recent_tweets(limit=500)  # era 200
```

### Agregar Nuevos Tipos de Alertas

En `services.py`, agregar nueva l√≥gica en las funciones `analyze_*_for_alerts()`:

```python
# Ejemplo: detectar dividendos
dividend_keywords = ['dividendo', 'dividendos', 'pago', 'distribuci√≥n']
for keyword in dividend_keywords:
    if keyword in text_to_analyze:
        alerts.append(Alert(
            title=f"Dividendos: {symbol}",
            description=f"Anuncio de dividendos detectado",
            alert_type="news",
            icon="cash",
            priority="medium",
            # ... resto de campos
        ))
```

---

## üìÅ Estructura del Proyecto

```
Alertas/
‚îú‚îÄ‚îÄ main.py              # Aplicaci√≥n FastAPI principal
‚îú‚îÄ‚îÄ config.py            # Configuraci√≥n y variables de entorno
‚îú‚îÄ‚îÄ database.py          # Conexi√≥n a MongoDB
‚îú‚îÄ‚îÄ models.py            # Modelos Pydantic (News, Tweet, Alert)
‚îú‚îÄ‚îÄ services.py          # L√≥gica de negocio y an√°lisis
‚îú‚îÄ‚îÄ requirements.txt     # Dependencias
‚îú‚îÄ‚îÄ .env                 # Variables de entorno
‚îú‚îÄ‚îÄ .gitignore          # Archivos ignorados
‚îú‚îÄ‚îÄ README.md           # Esta documentaci√≥n
‚îú‚îÄ‚îÄ FORMATO_ALERTAS.md  # Ejemplos de formato JSON
‚îî‚îÄ‚îÄ EJEMPLOS_USO.md     # Ejemplos adicionales
```

---

## ÔøΩ Detalles de An√°lisis

### Detecci√≥n de Tickers

**En Noticias:**
- Busca palabras en may√∫sculas de 2-5 letras
- Ejemplo: `YPF`, `GGAL`, `MERVAL`

**En Tweets:**
- Busca s√≠mbolos con `$` adelante
- Ejemplo: `$AAPL`, `$TSLA`, `$YPF`

### C√°lculo de Engagement (Tweets)

```python
engagement = retweet_count + like_count + reply_count
is_viral = engagement > 100
```

### Escalado de Prioridad

Los tweets virales (engagement > 100) escalan la prioridad:
- `medium` ‚Üí `high`
- `high` ‚Üí `critical`

### Sistema de An√°lisis

**M√©todo:** An√°lisis basado en reglas determin√≠sticas (sin Machine Learning)

```python
# B√∫squeda simple de palabras clave
critical_keywords = ['crisis', 'crash', 'colapso']
if keyword in text.lower():
    create_critical_alert()

# Comparaci√≥n num√©rica
engagement = retweets + likes + replies
if engagement > 100:
    mark_as_viral()
```

**Ventajas:**
- ‚ö° R√°pido y eficiente
- üéØ Predecible y controlable
- üîß F√°cil de personalizar
- üí∞ Sin costos de ML/APIs externas

---

## üìù Notas

- Las alertas se crean con `enabled: true` por defecto
- `lastTriggered` se establece solo si la alerta se activ√≥
- `triggerCount` cuenta cu√°ntas veces se activ√≥
- Los campos opcionales pueden ser `null`
- Las fechas se guardan en formato ISO 8601
- Los `_id` de MongoDB se convierten a strings

---

## üîó Enlaces √ötiles

- **Swagger UI:** http://localhost:8000/docs
- **ReDoc:** http://localhost:8000/redoc
- **Health Check:** http://localhost:8000/health

---

## üìÑ Licencia

Proyecto de uso libre para an√°lisis de mercados financieros.

---

**Versi√≥n:** 2.0.0 | **Fecha:** Octubre 2025
